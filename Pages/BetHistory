
import React, { useState, useMemo, useEffect } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation } from '@tanstack/react-query';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Badge } from '@/components/ui/badge';
import { 
  Search, 
  Filter, 
  Download, 
  TrendingUp, 
  TrendingDown,
  Target,
  DollarSign,
  BarChart3,
  ChevronLeft,
  ChevronRight,
  X,
  ChevronDown,
  ChevronUp,
  Calendar,
  Building2,
  Wallet as WalletIcon,
  Loader2,
  FileText,
  Eye
} from 'lucide-react';
import { toast } from 'sonner';
import { motion, AnimatePresence } from 'framer-motion';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Checkbox } from '@/components/ui/checkbox';
import { Separator } from '@/components/ui/separator';
import { Link } from 'react-router-dom';
import { createPageUrl } from '@/utils';

export default function BetHistoryPage() {
  const [currentUser, setCurrentUser] = useState(null);
  const [showFilters, setShowFilters] = useState(false);
  const [searchInput, setSearchInput] = useState('');
  const [expandedRows, setExpandedRows] = useState(new Set());
  const [isMobile, setIsMobile] = useState(false);
  
  const [filters, setFilters] = useState({
    search_query: '',
    start_date: '',
    end_date: '',
    bookmaker_ids: [],
    wallet_ids: [],
    statuses: [],
    sports: [],
    markets: [],
    min_odds: '',
    max_odds: '',
    min_stake: '',
    max_stake: '',
    sort_by: 'event_date',
    sort_order: 'desc',
    page: 1,
    page_size: 50
  });

  useEffect(() => {
    if (typeof window !== 'undefined') {
      const checkMobile = () => setIsMobile(window.innerWidth < 768);
      checkMobile();
      window.addEventListener('resize', checkMobile);
      return () => window.removeEventListener('resize', checkMobile);
    }
  }, []);

  useEffect(() => {
    loadUser();
  }, []);

  const loadUser = async () => {
    try {
      const user = await base44.auth.me();
      setCurrentUser(user);
    } catch (error) {
      console.error('Erro ao carregar usuário:', error);
    }
  };

  const { data: historyData, isLoading, isFetching, refetch } = useQuery({
    queryKey: ['bet-history', filters],
    queryFn: async () => {
      const response = await base44.functions.invoke('searchBetHistory', filters);
      return response.data;
    },
    enabled: !!currentUser,
    staleTime: 30000,
    keepPreviousData: true
  });

  const { data: bookmakers = [] } = useQuery({
    queryKey: ['bookmakers-filter'],
    queryFn: () => base44.entities.Bookmaker.list(),
    staleTime: 300000
  });

  const { data: wallets = [] } = useQuery({
    queryKey: ['wallets-filter', currentUser?.email],
    queryFn: async () => {
      if (!currentUser) return [];
      return await base44.entities.Wallet.filter({ created_by: currentUser.email });
    },
    enabled: !!currentUser,
    staleTime: 300000
  });

  const handleSearch = (value) => {
    setSearchInput(value);
    setFilters(prev => ({ ...prev, search_query: value, page: 1 }));
  };

  const updateFilter = (key, value) => {
    setFilters(prev => ({
      ...prev,
      [key]: value,
      page: key !== 'page' ? 1 : prev.page
    }));
  };

  const resetFilters = () => {
    setSearchInput('');
    setFilters({
      search_query: '',
      start_date: '',
      end_date: '',
      bookmaker_ids: [],
      wallet_ids: [],
      statuses: [],
      sports: [],
      markets: [],
      min_odds: '',
      max_odds: '',
      min_stake: '',
      max_stake: '',
      sort_by: 'event_date',
      sort_order: 'desc',
      page: 1,
      page_size: 50
    });
  };

  const toggleRow = (betId) => {
    const newExpanded = new Set(expandedRows);
    if (newExpanded.has(betId)) {
      newExpanded.delete(betId);
    } else {
      newExpanded.add(betId);
    }
    setExpandedRows(newExpanded);
  };

  const handleSort = (field) => {
    if (filters.sort_by === field) {
      updateFilter('sort_order', filters.sort_order === 'asc' ? 'desc' : 'asc');
    } else {
      updateFilter('sort_by', field);
      updateFilter('sort_order', 'desc');
    }
  };

  const activeFiltersCount = useMemo(() => {
    return Object.entries(filters).filter(([key, value]) => 
      value !== '' &&
      value !== undefined &&
      key !== 'page' &&
      key !== 'page_size' &&
      key !== 'sort_by' &&
      key !== 'sort_order' &&
      key !== 'search_query' &&
      (Array.isArray(value) ? value.length > 0 : true)
    ).length;
  }, [filters]);

  const bets = historyData?.bets || [];
  const metrics = historyData?.metrics || {};
  const pagination = historyData?.pagination || {};

  const handleExport = async (format) => {
    try {
      toast.loading(`Gerando arquivo ${format.toUpperCase()}...`);
      
      const response = await base44.functions.invoke('exportBetHistory', {
        filters,
        format
      });

      // O response.data já é o blob/conteúdo do arquivo
      const content = response.data;
      const blob = new Blob([content], { 
        type: format === 'csv' ? 'text/csv;charset=utf-8;' : 'application/vnd.ms-excel' 
      });
      
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `historico_apostas_${new Date().toISOString().split('T')[0]}.${format === 'xlsx' ? 'xls' : format}`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      a.remove();
      
      toast.dismiss();
      toast.success(`✅ Download de ${format.toUpperCase()} concluído!`);
    } catch (error) {
      console.error('❌ Erro no export:', error);
      toast.dismiss();
      toast.error(`❌ Erro ao exportar: ${error.message}`);
    }
  };

  if (!currentUser) {
    return (
      <div style={{ minHeight: '100vh', background: '#0a0a0a', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <Loader2 className="w-12 h-12 text-blue-400 animate-spin" />
      </div>
    );
  }

  return (
    <div style={{
      width: '100%',
      minHeight: '100vh',
      padding: isMobile ? '16px 12px' : '32px',
      background: '#0a0a0a',
      maxWidth: '100vw',
      overflowX: 'hidden'
    }}>
      <div style={{ maxWidth: '1400px', margin: '0 auto', width: '100%' }}>
        
        <motion.div
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          style={{
            display: 'flex',
            flexDirection: isMobile ? 'column' : 'row',
            alignItems: isMobile ? 'flex-start' : 'center',
            justifyContent: 'space-between',
            gap: isMobile ? '16px' : '24px',
            marginBottom: '24px'
          }}
        >
          <div>
            <h1 style={{
              fontSize: isMobile ? '24px' : '32px',
              fontWeight: 900,
              color: '#ffffff',
              marginBottom: '8px',
              display: 'flex',
              alignItems: 'center',
              gap: '12px'
            }}>
              <div style={{
                width: '4px',
                height: isMobile ? '28px' : '36px',
                background: 'linear-gradient(180deg, #d4af37 0%, #e5c158 100%)',
                borderRadius: '2px',
                boxShadow: '0 0 12px rgba(212, 175, 55, 0.6)'
              }} />
              Histórico de Apostas
            </h1>
            <p style={{ color: 'rgba(176, 176, 176, 0.8)', fontSize: isMobile ? '13px' : '14px', fontWeight: 500 }}>
              Todas as suas apostas em um só lugar
            </p>
          </div>

          <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
            <Button
              onClick={() => setShowFilters(!showFilters)}
              variant="outline"
              className="border-slate-700 text-white hover:bg-slate-800 hover:border-[#2d5016] relative"
              style={{
                background: 'rgba(20, 20, 20, 0.6)',
                borderColor: 'rgba(51, 51, 51, 0.5)'
              }}
            >
              <Filter className="w-4 h-4 mr-2" />
              Filtros
              {activeFiltersCount > 0 && (
                <Badge className="absolute -top-2 -right-2 bg-gradient-to-r from-[#2d5016] to-[#3d6b20] text-white px-2 py-0.5 text-xs border border-[#d4af37]">
                  {activeFiltersCount}
                </Badge>
              )}
            </Button>

            <Button
              onClick={() => handleExport('csv')}
              disabled={bets.length === 0}
              variant="outline"
              style={{
                background: 'rgba(20, 20, 20, 0.6)',
                borderColor: 'rgba(45, 80, 22, 0.5)',
                color: '#10b981'
              }}
              className="hover:bg-[#2d5016]/20 hover:border-[#3d6b20]"
            >
              <Download className="w-4 h-4 mr-2" />
              CSV
            </Button>

            <Button
              onClick={() => handleExport('xlsx')}
              disabled={bets.length === 0}
              variant="outline"
              style={{
                background: 'rgba(20, 20, 20, 0.6)',
                borderColor: 'rgba(45, 80, 22, 0.5)',
                color: '#10b981'
              }}
              className="hover:bg-[#2d5016]/20 hover:border-[#3d6b20]"
            >
              <FileText className="w-4 h-4 mr-2" />
              Excel
            </Button>
          </div>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.1 }}
          style={{ marginBottom: '20px' }}
        >
          <Card style={{
            background: 'rgba(20, 20, 20, 0.6)',
            borderColor: 'rgba(51, 51, 51, 0.5)'
          }}>
            <CardContent style={{ padding: isMobile ? '12px' : '16px' }}>
              <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" />
                <Input
                  value={searchInput}
                  onChange={(e) => handleSearch(e.target.value)}
                  placeholder="Buscar por evento, casa, conta, mercado..."
                  className="pl-10 bg-slate-900 border-slate-700 text-white"
                />
                {searchInput && (
                  <button
                    onClick={() => handleSearch('')}
                    className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white"
                  >
                    <X className="w-4 h-4" />
                  </button>
                )}
              </div>
            </CardContent>
          </Card>
        </motion.div>

        <AnimatePresence>
          {showFilters && (
            <motion.div
              initial={{ opacity: 0, height: 0 }}
              animate={{ opacity: 1, height: 'auto' }}
              exit={{ opacity: 0, height: 0 }}
              style={{ marginBottom: '20px' }}
            >
              <Card style={{
                background: 'rgba(20, 20, 20, 0.6)',
                borderColor: 'rgba(45, 80, 22, 0.3)'
              }}>
                <CardHeader>
                  <div className="flex items-center justify-between">
                    <CardTitle className="text-white flex items-center gap-2">
                      <Filter className="w-5 h-5 text-[#d4af37]" />
                      Filtros Avançados
                    </CardTitle>
                    <Button
                      onClick={() => setShowFilters(false)}
                      variant="ghost"
                      size="sm"
                      className="text-slate-400 hover:text-white"
                    >
                      <X className="w-4 h-4" />
                    </Button>
                  </div>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                      <Label className="text-white">Data Inicial</Label>
                      <Input
                        type="date"
                        value={filters.start_date}
                        onChange={(e) => updateFilter('start_date', e.target.value)}
                        className="bg-slate-900 border-slate-700 text-white"
                      />
                    </div>

                    <div>
                      <Label className="text-white">Data Final</Label>
                      <Input
                        type="date"
                        value={filters.end_date}
                        onChange={(e) => updateFilter('end_date', e.target.value)}
                        className="bg-slate-900 border-slate-700 text-white"
                      />
                    </div>

                    <div>
                      <Label className="text-white mb-2">Status</Label>
                      <div className="space-y-2 max-h-32 overflow-y-auto bg-slate-900 p-2 rounded border border-slate-700">
                        {['pendente', 'green', 'perda', 'bateu_protecao', 'cashout', 'anulada'].map(status => (
                          <div key={status} className="flex items-center gap-2">
                            <Checkbox
                              checked={filters.statuses.includes(status)}
                              onCheckedChange={(checked) => {
                                if (checked) {
                                  updateFilter('statuses', [...filters.statuses, status]);
                                } else {
                                  updateFilter('statuses', filters.statuses.filter(s => s !== status));
                                }
                              }}
                            />
                            <Label className="text-white text-sm cursor-pointer">
                              {status.charAt(0).toUpperCase() + status.slice(1)}
                            </Label>
                          </div>
                        ))}
                      </div>
                    </div>

                    <div>
                      <Label className="text-white mb-2">Esportes</Label>
                      <div className="space-y-2 max-h-32 overflow-y-auto bg-slate-900 p-2 rounded border border-slate-700">
                        {['futebol', 'basquete', 'tenis', 'volei', 'mma', 'esports'].map(sport => (
                          <div key={sport} className="flex items-center gap-2">
                            <Checkbox
                              checked={filters.sports.includes(sport)}
                              onCheckedChange={(checked) => {
                                if (checked) {
                                  updateFilter('sports', [...filters.sports, sport]);
                                } else {
                                  updateFilter('sports', filters.sports.filter(s => s !== sport));
                                }
                              }}
                            />
                            <Label className="text-white text-sm cursor-pointer">
                              {sport.charAt(0).toUpperCase() + sport.slice(1)}
                            </Label>
                          </div>
                        ))}
                      </div>
                    </div>

                    <div>
                      <Label className="text-white">Odd Mínima</Label>
                      <Input
                        type="number"
                        step="0.01"
                        value={filters.min_odds}
                        onChange={(e) => updateFilter('min_odds', e.target.value)}
                        placeholder="Ex: 1.50"
                        className="bg-slate-900 border-slate-700 text-white"
                      />
                    </div>

                    <div>
                      <Label className="text-white">Odd Máxima</Label>
                      <Input
                        type="number"
                        step="0.01"
                        value={filters.max_odds}
                        onChange={(e) => updateFilter('max_odds', e.target.value)}
                        placeholder="Ex: 5.00"
                        className="bg-slate-900 border-slate-700 text-white"
                      />
                    </div>

                    <div>
                      <Label className="text-white">Stake Mínimo</Label>
                      <Input
                        type="number"
                        step="0.01"
                        value={filters.min_stake}
                        onChange={(e) => updateFilter('min_stake', e.target.value)}
                        placeholder="Ex: 10.00"
                        className="bg-slate-900 border-slate-700 text-white"
                      />
                    </div>

                    <div>
                      <Label className="text-white">Stake Máximo</Label>
                      <Input
                        type="number"
                        step="0.01"
                        value={filters.max_stake}
                        onChange={(e) => updateFilter('max_stake', e.target.value)}
                        placeholder="Ex: 1000.00"
                        className="bg-slate-900 border-slate-700 text-white"
                      />
                    </div>
                  </div>

                  <div className="flex justify-end gap-2 pt-4">
                    <Button
                      onClick={resetFilters}
                      variant="outline"
                      style={{
                        background: 'rgba(20, 20, 20, 0.6)',
                        borderColor: 'rgba(197, 48, 48, 0.5)',
                        color: '#e53e3e'
                      }}
                      className="hover:bg-red-900/20"
                    >
                      Limpar Filtros
                    </Button>
                    <Button
                      onClick={() => setShowFilters(false)}
                      style={{
                        background: 'linear-gradient(to right, #2d5016, #3d6b20)',
                        color: '#ffffff'
                      }}
                      className="hover:from-[#3d6b20] hover:to-[#4a7f28]"
                    >
                      Aplicar Filtros
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </motion.div>
          )}
        </AnimatePresence>

        {activeFiltersCount > 0 && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            className="flex flex-wrap gap-2"
            style={{ marginBottom: '20px' }}
          >
            {filters.start_date && (
              <FilterTag
                label={`De: ${new Date(filters.start_date).toLocaleDateString('pt-BR')}`}
                onRemove={() => updateFilter('start_date', '')}
              />
            )}
            {filters.end_date && (
              <FilterTag
                label={`Até: ${new Date(filters.end_date).toLocaleDateString('pt-BR')}`}
                onRemove={() => updateFilter('end_date', '')}
              />
            )}
            {filters.statuses.length > 0 && (
              <FilterTag
                label={`Status: ${filters.statuses.length} selecionado(s)`}
                onRemove={() => updateFilter('statuses', [])}
              />
            )}
            {filters.sports.length > 0 && (
              <FilterTag
                label={`Esportes: ${filters.sports.length} selecionado(s)`}
                onRemove={() => updateFilter('sports', [])}
              />
            )}
          </motion.div>
        )}

        {metrics.total_bets !== undefined && (
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.2 }}
            style={{
              display: 'grid',
              gridTemplateColumns: isMobile ? '1fr' : 'repeat(auto-fit, minmax(200px, 1fr))',
              gap: isMobile ? '12px' : '16px',
              marginBottom: '24px'
            }}
          >
            <MetricCard
              label="Total de Apostas"
              value={metrics.total_bets}
              icon={BarChart3}
              color="text-blue-400"
              bgColor="from-blue-900/20 to-blue-800/10"
              borderColor="border-blue-600/30"
              loading={isFetching}
            />
            <MetricCard
              label="Total Apostado"
              value={`R$ ${metrics.total_staked?.toFixed(2) || '0.00'}`}
              icon={DollarSign}
              color="text-purple-400"
              bgColor="from-purple-900/20 to-purple-800/10"
              borderColor="border-purple-600/30"
              loading={isFetching}
            />
            <MetricCard
              label="Lucro/Prejuízo"
              value={`${metrics.total_profit >= 0 ? '+' : ''}R$ ${metrics.total_profit?.toFixed(2) || '0.00'}`}
              icon={metrics.total_profit >= 0 ? TrendingUp : TrendingDown}
              color={metrics.total_profit >= 0 ? 'text-green-400' : 'text-red-400'}
              bgColor={metrics.total_profit >= 0 ? 'from-green-900/20 to-green-800/10' : 'from-red-900/20 to-red-800/10'}
              borderColor={metrics.total_profit >= 0 ? 'border-green-600/30' : 'border-red-600/30'}
              loading={isFetching}
            />
            <MetricCard
              label="ROI"
              value={`${metrics.roi >= 0 ? '+' : ''}${metrics.roi?.toFixed(2) || '0.00'}%`}
              icon={Target}
              color={metrics.roi >= 0 ? 'text-green-400' : 'text-red-400'}
              bgColor={metrics.roi >= 0 ? 'from-green-900/20 to-green-800/10' : 'from-red-900/20 to-red-800/10'}
              borderColor={metrics.roi >= 0 ? 'border-green-600/30' : 'border-red-600/30'}
              loading={isFetching}
            />
            <MetricCard
              label="Win Rate"
              value={`${metrics.win_rate?.toFixed(1) || '0.0'}%`}
              icon={Target}
              color="text-[#d4af37]"
              bgColor="from-amber-900/20 to-amber-800/10"
              borderColor="border-[#d4af37]/30"
              subtitle={`${metrics.winning_bets}/${metrics.total_bets} vitórias`}
              loading={isFetching}
            />
          </motion.div>
        )}

        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.3 }}
        >
          {isLoading ? (
            <Card style={{
              background: 'rgba(20, 20, 20, 0.6)',
              borderColor: 'rgba(51, 51, 51, 0.5)'
            }}>
              <CardContent className="p-12 flex flex-col items-center justify-center">
                <Loader2 className="w-12 h-12 text-[#d4af37] animate-spin mb-4" />
                <p className="text-slate-400">Carregando histórico...</p>
              </CardContent>
            </Card>
          ) : bets.length === 0 ? (
            <Card style={{
              background: 'rgba(20, 20, 20, 0.6)',
              borderColor: 'rgba(51, 51, 51, 0.5)'
            }}>
              <CardContent className="p-12 text-center">
                <BarChart3 className="w-16 h-16 text-slate-600 mx-auto mb-4 opacity-50" />
                <p className="text-xl text-white mb-2">Nenhuma aposta encontrada</p>
                <p className="text-slate-400 mb-4">
                  {activeFiltersCount > 0
                    ? 'Tente ajustar os filtros ou limpar a busca'
                    : 'Você ainda não tem apostas registradas'}
                </p>
                {activeFiltersCount > 0 && (
                  <Button
                    onClick={resetFilters}
                    style={{
                      background: 'linear-gradient(to right, #2d5016, #3d6b20)'
                    }}
                  >
                    Limpar Filtros
                  </Button>
                )}
              </CardContent>
            </Card>
          ) : (
            <div className="space-y-3">
              {bets.map((bet) => (
                <BetHistoryCard
                  key={bet.id}
                  bet={bet}
                  expanded={expandedRows.has(bet.id)}
                  onToggle={() => toggleRow(bet.id)}
                />
              ))}
            </div>
          )}
        </motion.div>

        {pagination.total_pages > 1 && (
          <Card style={{
            background: 'rgba(20, 20, 20, 0.6)',
            borderColor: 'rgba(51, 51, 51, 0.5)',
            marginTop: '24px'
          }}>
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <p className="text-sm text-slate-400">
                  Mostrando {((pagination.page - 1) * pagination.page_size) + 1} - {
                    Math.min(pagination.page * pagination.page_size, pagination.total_count)
                  } de {pagination.total_count} apostas
                </p>

                <div className="flex items-center gap-2">
                  <Button
                    onClick={() => updateFilter('page', filters.page - 1)}
                    disabled={!pagination.has_previous}
                    size="sm"
                    variant="outline"
                    style={{
                      background: 'rgba(20, 20, 20, 0.6)',
                      borderColor: 'rgba(51, 51, 51, 0.5)'
                    }}
                  >
                    <ChevronLeft className="w-4 h-4" />
                  </Button>

                  <span className="text-sm text-white px-3">
                    Página {pagination.page} de {pagination.total_pages}
                  </span>

                  <Button
                    onClick={() => updateFilter('page', filters.page + 1)}
                    disabled={!pagination.has_next}
                    size="sm"
                    variant="outline"
                    style={{
                      background: 'rgba(20, 20, 20, 0.6)',
                      borderColor: 'rgba(51, 51, 51, 0.5)'
                    }}
                  >
                    <ChevronRight className="w-4 h-4" />
                  </Button>
                </div>
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  );
}

function FilterTag({ label, onRemove }) {
  return (
    <div style={{
      display: 'inline-flex',
      alignItems: 'center',
      gap: '6px',
      padding: '6px 12px',
      background: 'rgba(45, 80, 22, 0.3)',
      border: '1px solid rgba(212, 175, 55, 0.4)',
      borderRadius: '20px',
      fontSize: '13px',
      color: '#d4af37',
      fontWeight: 600
    }}>
      {label}
      <button
        onClick={onRemove}
        style={{
          background: 'rgba(212, 175, 55, 0.2)',
          borderRadius: '50%',
          padding: '2px',
          cursor: 'pointer',
          border: 'none',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center'
        }}
        className="hover:bg-[#d4af37]/30 transition-colors"
      >
        <X className="w-3 h-3 text-[#d4af37]" />
      </button>
    </div>
  );
}

function MetricCard({ label, value, icon: Icon, color, bgColor, borderColor, subtitle, loading }) {
  return (
    <Card style={{
      background: 'rgba(20, 20, 20, 0.6)',
      borderWidth: '1px',
      position: 'relative',
      overflow: 'hidden'
    }} className={`${borderColor} hover:border-[#2d5016] transition-all ${loading ? 'animate-pulse' : ''}`}>
      <div style={{
        position: 'absolute',
        top: 0,
        left: 0,
        right: 0,
        height: '100%',
        background: `linear-gradient(135deg, ${bgColor})`,
        opacity: 0.5,
        pointerEvents: 'none'
      }} />
      <CardContent className="p-4" style={{ position: 'relative', zIndex: 1 }}>
        <div className="flex items-start justify-between">
          <div className="flex-1">
            <p className="text-sm text-slate-400 mb-1 font-medium">{label}</p>
            <p className={`text-2xl font-black ${color}`}>{value}</p>
            {subtitle && (
              <p className="text-xs text-slate-500 mt-1 font-medium">{subtitle}</p>
            )}
          </div>
          <Icon className={`w-8 h-8 ${color} opacity-60`} />
        </div>
      </CardContent>
    </Card>
  );
}

function BetHistoryCard({ bet, expanded, onToggle }) {
  const getStatusConfig = (status) => {
    const configs = {
      pendente: { label: 'Pendente', bg: 'from-yellow-900/20 to-yellow-800/10', text: 'text-yellow-300', border: 'border-yellow-600/40' },
      green: { label: 'Green', bg: 'from-green-900/20 to-green-800/10', text: 'text-green-300', border: 'border-green-600/40' },
      perda: { label: 'Perda', bg: 'from-red-900/20 to-red-800/10', text: 'text-red-300', border: 'border-red-600/40' },
      bateu_protecao: { label: 'Proteção', bg: 'from-orange-900/20 to-orange-800/10', text: 'text-orange-300', border: 'border-orange-600/40' },
      duplo_green: { label: 'Duplo Green', bg: 'from-emerald-900/20 to-emerald-800/10', text: 'text-emerald-300', border: 'border-emerald-600/40' },
      triplo_green: { label: 'Triplo Green', bg: 'from-emerald-900/20 to-emerald-800/10', text: 'text-emerald-300', border: 'border-emerald-600/40' },
      cashout: { label: 'Cashout', bg: 'from-blue-900/20 to-blue-800/10', text: 'text-blue-300', border: 'border-blue-600/40' },
      anulada: { label: 'Anulada', bg: 'from-gray-900/20 to-gray-800/10', text: 'text-gray-300', border: 'border-gray-600/40' }
    };
    return configs[status] || configs.pendente;
  };

  const statusConfig = getStatusConfig(bet.status);
  const profitLoss = bet.profit_loss || 0;
  const roi = bet.stake > 0 ? (profitLoss / bet.stake) * 100 : 0;

  return (
    <Card style={{
      background: 'rgba(20, 20, 20, 0.6)',
      borderColor: 'rgba(51, 51, 51, 0.5)'
    }} className="hover:border-[#2d5016] transition-all">
      <CardContent className="p-4">
        <div 
          className="flex items-center justify-between cursor-pointer"
          onClick={onToggle}
        >
          <div className="flex-1 grid grid-cols-1 md:grid-cols-5 gap-4">
            <div className="md:col-span-2">
              <div className="flex items-start gap-3">
                <button className="text-slate-400 hover:text-[#d4af37] mt-1 transition-colors">
                  {expanded ? <ChevronDown className="w-5 h-5" /> : <ChevronUp className="w-5 h-5" />}
                </button>
                <div>
                  <p className="text-xs text-slate-500 mb-1 font-medium">
                    {new Date(bet.event_date || bet.created_date).toLocaleDateString('pt-BR')}
                  </p>
                  <p className="text-white font-bold text-lg">{bet.event_name}</p>
                  <p className="text-xs text-slate-400 mt-0.5">{bet.sport}</p>
                </div>
              </div>
            </div>

            <div>
              <p className="text-xs text-slate-500 mb-1 font-medium">Casa/Conta</p>
              <p className="text-white font-semibold">{bet.bookmaker_name}</p>
              <p className="text-xs text-slate-400">{bet.wallet_name}</p>
            </div>

            <div>
              <p className="text-xs text-slate-500 mb-1 font-medium">Mercado</p>
              <p className="text-white text-sm font-medium">{bet.market}</p>
              <p className="text-xs text-[#d4af37] font-semibold">{bet.selection}</p>
            </div>

            <div className="flex flex-col items-end gap-2">
              <Badge className={`bg-gradient-to-r ${statusConfig.bg} ${statusConfig.text} border ${statusConfig.border} font-bold`}>
                {statusConfig.label}
              </Badge>
              <div className="text-right">
                <p className="text-xs text-slate-500">Stake: R$ {bet.stake?.toFixed(2)}</p>
                <p className="text-xs text-slate-500">Odd: {bet.odds?.toFixed(2)}</p>
                <p className={`text-lg font-black mt-1 ${profitLoss >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                  {profitLoss >= 0 ? '+' : ''}R$ {profitLoss.toFixed(2)}
                </p>
              </div>
            </div>
          </div>
        </div>

        <AnimatePresence>
          {expanded && (
            <motion.div
              initial={{ opacity: 0, height: 0 }}
              animate={{ opacity: 1, height: 'auto' }}
              exit={{ opacity: 0, height: 0 }}
              className="mt-4 pt-4"
              style={{
                borderTop: '1px solid rgba(45, 80, 22, 0.3)'
              }}
            >
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div>
                  <span className="text-slate-400 font-medium">ROI:</span>
                  <p className={`font-bold ${roi >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                    {roi.toFixed(2)}%
                  </p>
                </div>

                {bet.procedure_type && (
                  <div>
                    <span className="text-slate-400 font-medium">Procedimento:</span>
                    <p className="text-white font-medium">{bet.procedure_type}</p>
                  </div>
                )}

                {bet.is_freebet && (
                  <div>
                    <span className="text-slate-400 font-medium">Freebet:</span>
                    <p className="text-[#d4af37] font-bold">Sim</p>
                  </div>
                )}

                {bet.protection_bookmakers && bet.protection_bookmakers.length > 0 && (
                  <div>
                    <span className="text-slate-400 font-medium">Proteções:</span>
                    <p className="text-orange-400 font-medium">
                      {bet.protection_bookmakers.length} casa(s)
                    </p>
                  </div>
                )}

                <div>
                  <span className="text-slate-400 font-medium">Criado em:</span>
                  <p className="text-white">
                    {new Date(bet.created_date).toLocaleString('pt-BR')}
                  </p>
                </div>

                {bet.notes && (
                  <div className="md:col-span-3">
                    <span className="text-slate-400 font-medium">Observações:</span>
                    <p className="text-white mt-1">{bet.notes}</p>
                  </div>
                )}
              </div>

              <div className="flex gap-2 mt-4">
                <Link to={`${createPageUrl('Bets')}?id=${bet.id}`}>
                  <Button
                    size="sm"
                    variant="outline"
                    style={{
                      background: 'rgba(20, 20, 20, 0.6)',
                      borderColor: 'rgba(45, 80, 22, 0.5)',
                      color: '#d4af37'
                    }}
                    className="hover:bg-[#2d5016]/20 hover:border-[#3d6b20]"
                  >
                    <Eye className="w-4 h-4 mr-2" />
                    Ver Detalhes
                  </Button>
                </Link>
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </CardContent>
    </Card>
  );
}
