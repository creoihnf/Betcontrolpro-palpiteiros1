import React, { useState, useMemo } from "react";
import { useNavigate } from "react-router-dom";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Button } from "@/components/ui/button";
import { ArrowLeft, ArrowRight, Calculator, Gift } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { motion } from "framer-motion";
import { Alert, AlertDescription } from "@/components/ui/alert";

export default function FreebetCalculatorPage() {
  const navigate = useNavigate();
  
  const [freebetValor, setFreebetValor] = useState("");
  const [oddFreebet, setOddFreebet] = useState("");
  const [oddProtecao, setOddProtecao] = useState("");

  // C√°lculo da extra√ß√£o de freebet
  const resultado = useMemo(() => {
    const freebet = parseFloat(freebetValor) || 0;
    const oddF = parseFloat(oddFreebet) || 0;
    const oddP = parseFloat(oddProtecao) || 0;

    if (freebet === 0 || oddF <= 1 || oddP <= 1) {
      return null;
    }

    // Valor da prote√ß√£o
    const valorProtecao = (freebet * (oddF - 1)) / oddP;

    // Retornos
    const retornoFreebet = freebet * (oddF - 1); // Freebet n√£o conta o stake
    const retornoProtecao = valorProtecao * oddP;

    // Lucro l√≠quido
    const lucroSeFreebetGanha = retornoFreebet - valorProtecao;
    const lucroSeProtecaoGanha = retornoProtecao - valorProtecao;

    const lucroLiquido = Math.min(lucroSeFreebetGanha, lucroSeProtecaoGanha);
    const percentualExtracao = (lucroLiquido / freebet) * 100;

    return {
      valorProtecao: valorProtecao.toFixed(2),
      retornoFreebet: retornoFreebet.toFixed(2),
      retornoProtecao: retornoProtecao.toFixed(2),
      lucroSeFreebetGanha: lucroSeFreebetGanha.toFixed(2),
      lucroSeProtecaoGanha: lucroSeProtecaoGanha.toFixed(2),
      lucroLiquido: lucroLiquido.toFixed(2),
      percentualExtracao: percentualExtracao.toFixed(2),
      isViavel: percentualExtracao > 60 // Extra√ß√£o acima de 60% √© boa
    };
  }, [freebetValor, oddFreebet, oddProtecao]);

  const handleContinuar = () => {
    // Salvar dados no localStorage para uso na p√°gina de Nova Freebet
    if (resultado) {
      localStorage.setItem('freebet_calculator_data', JSON.stringify({
        freebet_value: freebetValor,
        stake: freebetValor,
        odds: oddFreebet,
        protection_bookmakers: [{
          stake: resultado.valorProtecao,
          odds: oddProtecao
        }],
        potential_net_profit: resultado.lucroLiquido,
        calculated_at: new Date().toISOString()
      }));
    }

    // Redirecionar para AddFreebetBet
    navigate('/AddFreebetBet');
  };

  const lucro = resultado ? parseFloat(resultado.lucroLiquido) : 0;

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 p-4 md:p-8">
      <div className="max-w-5xl mx-auto">
        {/* Header */}
        <div className="mb-8 flex flex-col md:flex-row md:items-center gap-4">
          <Button
            variant="outline"
            size="icon"
            onClick={() => navigate('/SurebetCalculator')}
            className="bg-slate-800 border-slate-700 text-white hover:bg-slate-700 self-start"
          >
            <ArrowLeft className="w-5 h-5" />
          </Button>
          <div className="flex-1">
            <h1 className="text-3xl md:text-4xl font-bold text-white flex items-center gap-3">
              <Gift className="w-8 h-8 md:w-10 md:h-10 text-pink-500" />
              Calculadora Freebet
            </h1>
            <p className="text-slate-400 mt-2 text-sm md:text-base">
              Calcule a extra√ß√£o de freebets e b√¥nus
            </p>
          </div>
        </div>

        <div className="grid lg:grid-cols-[1fr,450px] gap-6">
          {/* CONFIGURA√á√ÉO */}
          <div className="space-y-6">
            {/* Freebet */}
            <Card className="bg-gradient-to-br from-pink-900/20 to-pink-800/20 border-2 border-pink-700 shadow-2xl">
              <CardHeader className="border-b border-pink-700/50">
                <CardTitle className="text-white flex items-center gap-2 text-lg">
                  <Gift className="w-5 h-5 text-pink-400" />
                  Freebet
                </CardTitle>
              </CardHeader>
              <CardContent className="pt-6 space-y-4">
                <div>
                  <Label className="text-slate-300 font-semibold">Valor da Freebet (R$) *</Label>
                  <Input
                    type="number"
                    step="0.01"
                    value={freebetValor}
                    onChange={(e) => setFreebetValor(e.target.value)}
                    placeholder="0.00"
                    className="mt-2 bg-slate-900 border-slate-700 text-white h-14 text-xl font-bold"
                  />
                </div>

                <div>
                  <Label className="text-slate-300 font-semibold">Odd da Freebet *</Label>
                  <Input
                    type="number"
                    step="0.01"
                    value={oddFreebet}
                    onChange={(e) => setOddFreebet(e.target.value)}
                    placeholder="1.00"
                    className="mt-2 bg-slate-900 border-slate-700 text-white h-12 font-bold"
                  />
                  <p className="text-xs text-slate-400 mt-1">
                    üí° Odd onde voc√™ usar√° a freebet
                  </p>
                </div>

                {resultado && (
                  <div className="pt-3 border-t border-pink-700">
                    <p className="text-xs text-slate-300 mb-1">üí∞ Retorno se ganhar:</p>
                    <p className="text-2xl font-bold text-pink-400">
                      R$ {resultado.retornoFreebet}
                    </p>
                    <p className="text-xs text-slate-400 mt-1">
                      (Freebet n√£o conta o stake)
                    </p>
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Prote√ß√£o */}
            <Card className="bg-gradient-to-br from-blue-900/20 to-blue-800/20 border-2 border-blue-700 shadow-2xl">
              <CardHeader className="border-b border-blue-700/50">
                <CardTitle className="text-white flex items-center gap-2 text-lg">
                  <Calculator className="w-5 h-5 text-blue-400" />
                  Prote√ß√£o
                </CardTitle>
              </CardHeader>
              <CardContent className="pt-6 space-y-4">
                <div>
                  <Label className="text-slate-300 font-semibold">Odd da Prote√ß√£o *</Label>
                  <Input
                    type="number"
                    step="0.01"
                    value={oddProtecao}
                    onChange={(e) => setOddProtecao(e.target.value)}
                    placeholder="1.00"
                    className="mt-2 bg-slate-900 border-slate-700 text-white h-12 font-bold"
                  />
                  <p className="text-xs text-slate-400 mt-1">
                    üí° Odd oposta na outra casa
                  </p>
                </div>

                {resultado && (
                  <div className="pt-3 border-t border-blue-700">
                    <p className="text-xs text-slate-300 mb-1">üí∞ Valor a apostar:</p>
                    <p className="text-2xl font-bold text-blue-400">
                      R$ {resultado.valorProtecao}
                    </p>
                    <p className="text-xs text-slate-400 mt-1">
                      Retorno: R$ {resultado.retornoProtecao}
                    </p>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>

          {/* RESULTADOS */}
          <div className="lg:sticky lg:top-8 lg:self-start">
            <Card className="bg-slate-800/50 border-slate-700 shadow-2xl">
              <CardHeader className="border-b border-slate-700">
                <CardTitle className="text-white flex items-center gap-2 text-lg">
                  <Calculator className="w-5 h-5 text-pink-400" />
                  Resultados
                </CardTitle>
              </CardHeader>
              <CardContent className="pt-6">
                {!resultado ? (
                  <div className="text-center py-16 text-slate-500">
                    <Gift className="w-16 h-16 mx-auto mb-4 text-slate-600" />
                    <p className="text-base">Configure a freebet</p>
                    <p className="text-xs mt-2">Os resultados aparecer√£o aqui</p>
                  </div>
                ) : (
                  <div className="space-y-6">
                    {/* Lucro L√≠quido */}
                    <motion.div
                      initial={{ scale: 0.9, opacity: 0 }}
                      animate={{ scale: 1, opacity: 1 }}
                      transition={{ duration: 0.3 }}
                    >
                      <Card className={`${
                        lucro > 0 
                          ? 'bg-gradient-to-r from-green-600 to-green-500 shadow-green-500/50' 
                          : 'bg-gradient-to-r from-red-600 to-red-500 shadow-red-500/50'
                      } shadow-2xl border-0`}>
                        <CardContent className="pt-8 pb-8 text-center">
                          <p className="text-white text-sm mb-3 font-semibold">
                            LUCRO L√çQUIDO GARANTIDO
                          </p>
                          <p className="text-5xl md:text-6xl font-black text-white drop-shadow-lg">
                            {lucro >= 0 ? '+' : ''}R$ {resultado.lucroLiquido}
                          </p>
                          <p className="text-white/90 text-base mt-4 font-semibold">
                            {resultado.percentualExtracao}% da freebet
                          </p>
                          <Badge className={`mt-4 ${
                            resultado.isViavel 
                              ? 'bg-white text-green-600' 
                              : 'bg-white text-yellow-600'
                          } font-bold text-sm px-4 py-1`}>
                            {resultado.isViavel ? '‚úÖ BOA EXTRA√á√ÉO' : '‚ö†Ô∏è EXTRA√á√ÉO BAIXA'}
                          </Badge>
                        </CardContent>
                      </Card>
                    </motion.div>

                    {/* Cen√°rios */}
                    <div>
                      <h3 className="text-white font-semibold mb-3 text-sm">Cen√°rios</h3>
                      <div className="grid grid-cols-2 gap-3">
                        <Card className="bg-pink-900/20 border-pink-700 border-2">
                          <CardContent className="pt-6 text-center">
                            <p className="text-xs text-slate-400 mb-2">Freebet ganha</p>
                            <p className="text-2xl font-bold text-pink-400">
                              +R$ {resultado.lucroSeFreebetGanha}
                            </p>
                          </CardContent>
                        </Card>

                        <Card className="bg-blue-900/20 border-blue-700 border-2">
                          <CardContent className="pt-6 text-center">
                            <p className="text-xs text-slate-400 mb-2">Prote√ß√£o ganha</p>
                            <p className="text-2xl font-bold text-blue-400">
                              +R$ {resultado.lucroSeProtecaoGanha}
                            </p>
                          </CardContent>
                        </Card>
                      </div>
                    </div>

                    {/* Dica */}
                    {!resultado.isViavel && (
                      <Alert className="bg-yellow-900/20 border-yellow-700">
                        <AlertDescription className="text-yellow-200 text-sm">
                          <strong>üí° Dica:</strong> Extra√ß√µes acima de 70% s√£o ideais. Procure odds mais altas para melhorar.
                        </AlertDescription>
                      </Alert>
                    )}

                    {/* Bot√£o Continuar */}
                    <Button
                      onClick={handleContinuar}
                      className="w-full bg-gradient-to-r from-pink-600 to-pink-500 hover:from-pink-700 hover:to-pink-600 h-14 font-semibold text-base"
                    >
                      Continuar para Nova Freebet
                      <ArrowRight className="w-5 h-5 ml-2" />
                    </Button>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </div>
  );
}
