import React, { useState, useEffect, useCallback, useMemo } from "react";
import { Bet } from "@/entities/Bet";
import { Bookmaker } from "@/entities/Bookmaker";
import { Wallet } from "@/entities/Wallet";
import { Profile } from "@/entities/Profile";
import { User } from "@/entities/User";
import { ProfitRecord } from "@/entities/ProfitRecord";
import { Payment } from "@/entities/Payment";
import { useQuery } from '@tanstack/react-query';

import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Skeleton } from "@/components/ui/skeleton";
import { 
  DollarSign, TrendingUp, Filter, Wallet as WalletIcon, Link as LinkIcon, 
  Users, Building2, Plus, Calendar, X, Download, Search, ChevronDown,
  TrendingDown, Activity, Target, Award, AlertCircle
} from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from "@/components/ui/dialog";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import { toast } from "sonner";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { motion, AnimatePresence } from "framer-motion";

import InteractiveTutorial from "../components/tutorial/InteractiveTutorial";
import { getTutorial } from "../components/tutorial/tutorialContent";

// âœ… Helper para formataÃ§Ã£o de moeda
const formatCurrency = (value) => {
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL',
  }).format(value);
};

// âœ… COMPONENTE: StatCard (Melhorado com animaÃ§Ã£o)
const StatCard = ({ title, value, subtitle, icon: Icon, gradient, trend, isLoading }) => {
  if (isLoading) {
    return <Skeleton className="h-40 rounded-xl" />;
  }

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.3 }}
    >
      <Card className={`${gradient} border-0 overflow-hidden relative`}>
        <div className="absolute top-0 right-0 w-32 h-32 opacity-10">
          <Icon className="w-full h-full" />
        </div>
        <CardHeader className="flex flex-row items-center justify-between pb-2 relative z-10">
          <CardTitle className="text-sm md:text-base font-medium text-white/90">
            {title}
          </CardTitle>
          <Icon className="w-5 h-5 text-white/80" />
        </CardHeader>
        <CardContent className="relative z-10">
          <div className="text-2xl md:text-3xl font-bold text-white mb-1">
            {value}
          </div>
          <div className="flex items-center gap-2">
            <p className="text-xs text-white/70">
              {subtitle}
            </p>
            {trend && (
              <Badge variant="secondary" className="bg-white/20 text-white border-0 text-xs">
                {trend}
              </Badge>
            )}
          </div>
        </CardContent>
      </Card>
    </motion.div>
  );
};

// âœ… COMPONENTE: ProcedureCard (Melhorado)
const ProcedureCard = ({ group, procedureLabel }) => {
  const isPositive = group.totalProfit >= 0;
  
  return (
    <motion.div
      initial={{ opacity: 0, scale: 0.95 }}
      animate={{ opacity: 1, scale: 1 }}
      transition={{ duration: 0.2 }}
      whileHover={{ scale: 1.02 }}
      className="p-6 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all"
    >
      <div className="flex justify-between items-start mb-4">
        <div>
          <h3 className="text-lg font-bold text-slate-900 dark:text-white capitalize flex items-center gap-2">
            {procedureLabel}
            <Badge variant="outline" className="text-xs">
              {group.count}
            </Badge>
          </h3>
          <p className="text-sm text-slate-600 dark:text-slate-400">
            {group.count} {group.count === 1 ? 'operaÃ§Ã£o' : 'operaÃ§Ãµes'}
          </p>
        </div>
        <Badge className={`
          ${isPositive 
            ? 'bg-green-100 text-green-800 border-green-200 dark:bg-green-900/30 dark:text-green-300 dark:border-green-700' 
            : 'bg-red-100 text-red-800 border-red-200 dark:bg-red-900/30 dark:text-red-300 dark:border-red-700'
          } border font-bold
        `}>
          {isPositive ? '+' : ''}R$ {group.totalProfit.toFixed(2)}
        </Badge>
      </div>

      <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
        <div className="bg-white dark:bg-slate-700 p-3 rounded-lg">
          <div className="flex items-center gap-2 mb-1">
            <DollarSign className="w-3 h-3 text-slate-500 dark:text-slate-400" />
            <p className="text-xs text-slate-500 dark:text-slate-400">Investido</p>
          </div>
          <p className="font-bold text-slate-900 dark:text-white">
            {formatCurrency(group.totalStake)}
          </p>
        </div>
        
        <div className="bg-white dark:bg-slate-700 p-3 rounded-lg">
          <div className="flex items-center gap-2 mb-1">
            <TrendingUp className="w-3 h-3 text-blue-500" />
            <p className="text-xs text-slate-500 dark:text-slate-400">ROI</p>
          </div>
          <p className="font-bold text-blue-600 dark:text-blue-400">
            {group.roi.toFixed(1)}%
          </p>
        </div>
        
        <div className="bg-white dark:bg-slate-700 p-3 rounded-lg">
          <div className="flex items-center gap-2 mb-1">
            <Target className="w-3 h-3 text-purple-500" />
            <p className="text-xs text-slate-500 dark:text-slate-400">Win Rate</p>
          </div>
          <p className="font-bold text-purple-600 dark:text-purple-400">
            {group.winRate.toFixed(1)}%
          </p>
        </div>
        
        <div className="bg-white dark:bg-slate-700 p-3 rounded-lg">
          <div className="flex items-center gap-2 mb-1">
            <Award className="w-3 h-3 text-green-500" />
            <p className="text-xs text-slate-500 dark:text-slate-400">Lucro</p>
          </div>
          <p className={`font-bold ${isPositive ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>
            {isPositive ? '+' : ''}{formatCurrency(group.totalProfit)}
          </p>
        </div>
      </div>
    </motion.div>
  );
};

// âœ… COMPONENTE PRINCIPAL
export default function ProfitsPage() {
  const [bets, setBets] = useState([]);
  const [bookmakers, setBookmakers] = useState([]);
  const [wallets, setWallets] = useState([]);
  const [profiles, setProfiles] = useState([]);
  const [profitRecords, setProfitRecords] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [currentUser, setCurrentUser] = useState(null);

  const [selectedProcedures, setSelectedProcedures] = useState(['todos']);
  const [selectedBookmakers, setSelectedBookmakers] = useState(['todas']);
  const [selectedWallet, setSelectedWallet] = useState('todas');

  const [showLinkDialog, setShowLinkDialog] = useState(false);
  const [showAddRecordDialog, setShowAddRecordDialog] = useState(false);
  const [walletLinks, setWalletLinks] = useState({});

  const [showBookmakersFilter, setShowBookmakersFilter] = useState(false);
  const [showProceduresFilter, setShowProceduresFilter] = useState(false);
  
  // âœ… NOVO: Estados para busca
  const [searchBookmaker, setSearchBookmaker] = useState('');
  const [searchProcedure, setSearchProcedure] = useState('');

  const [newRecord, setNewRecord] = useState({
    title: '',
    amount: '',
    record_date: new Date().toISOString().split('T')[0],
    period_type: 'daily',
    category: 'aposta',
    bookmaker_id: '',
    wallet_id: '',
    notes: ''
  });

  const { data: payments = [] } = useQuery({
    queryKey: ['payments', currentUser?.email],
    queryFn: async () => {
      if (!currentUser?.email) return [];
      return await Payment.filter({ created_by: currentUser.email });
    },
    enabled: !!currentUser?.email,
  });

  const profitsTutorial = getTutorial('profits');

  const loadData = useCallback(async () => {
    if (bets.length === 0) {
      setIsLoading(true);
    }

    try {
      const user = await User.me();
      setCurrentUser(user);

      const [betsData, bookmakersData, walletsData, profilesData, profitRecordsData] = await Promise.all([
        Bet.filter({ created_by: user.email }, "-updated_date"),
        Bookmaker.filter({ created_by: user.email }),
        Wallet.filter({ created_by: user.email }),
        Profile.filter({ created_by: user.email }),
        ProfitRecord.filter({ created_by: user.email }, "-record_date")
      ]);

      setBets(betsData.filter(b =>
        ['green', 'red', 'bateu_protecao', 'meio_duplo', 'duplo_green', 'triplo_green'].includes(b.status)
      ));

      setBookmakers(bookmakersData.filter(b => b.is_active));
      setWallets(walletsData.filter(w => w.is_active && (w.is_main_account || w.profile_id)));
      setProfiles(profilesData.filter(p => p.is_active));
      setProfitRecords(profitRecordsData);

      const links = {};
      walletsData.forEach(wallet => {
        if (wallet.linked_main_wallet_id) {
          links[wallet.id] = wallet.linked_main_wallet_id;
        }
      });
      setWalletLinks(links);
    } catch (error) {
      console.error('Erro ao carregar dados:', error);
      toast.error('âŒ Erro ao carregar dados');
    } finally {
      setIsLoading(false);
    }
  }, [bets.length]);

  useEffect(() => {
    loadData();
  }, [loadData]);

  // âœ… OTIMIZADO: CÃ¡lculo de lucros com useMemo
  const calculateProfits = useMemo(() => {
    const totalProfit = bets.reduce((sum, bet) => sum + (bet.profit_loss || 0), 0);
    const manualProfits = profitRecords.reduce((sum, record) => sum + (record.amount || 0), 0);

    const processedGroups = new Set();
    const groupKey = (bet) => `${bet.event_name}_${bet.market}_${bet.selection}_${bet.odds}_${bet.event_date}_${bet.bookmaker_id}`;

    let totalInvestment = 0;
    let greenOperations = 0;
    let redOperations = 0;

    bets.forEach(bet => {
      const key = groupKey(bet);

      if (!processedGroups.has(key)) {
        const isFreebetExtraction = bet.procedure_type === 'extracao_freebet';
        const mainStake = isFreebetExtraction ? 0 : (bet.stake || 0);
        const protectionStake = (bet.protection_bookmakers || []).reduce((sum, p) => sum + (parseFloat(p.stake) || 0), 0);
        const additionalStake = (bet.additional_bets || []).reduce((sum, a) => sum + (parseFloat(a.stake) || 0), 0);
        totalInvestment += mainStake + protectionStake + additionalStake + (bet.procedure_loss || 0);

        if (['green', 'bateu_protecao', 'duplo_green', 'triplo_green', 'meio_duplo'].includes(bet.status)) {
          greenOperations++;
        } else if (bet.status === 'red') {
          redOperations++;
        }

        processedGroups.add(key);
      }
    });

    const totalPagamentos = payments
      .filter(p => p.status === 'paid')
      .reduce((sum, p) => sum + (p.amount || 0), 0);

    const lucroBruto = totalProfit + manualProfits;
    const lucroLiquido = lucroBruto - totalPagamentos;
    const roi = totalInvestment > 0 ? (lucroLiquido / totalInvestment) * 100 : 0;
    const winRate = (greenOperations + redOperations) > 0 ? (greenOperations / (greenOperations + redOperations)) * 100 : 0;

    return {
      lucroBruto,
      lucroLiquido,
      totalPagamentos,
      totalInvestment,
      roi,
      greenOperations,
      redOperations,
      winRate
    };
  }, [bets, profitRecords, payments]);

  // âœ… OTIMIZADO: Filtros com useMemo
  const filteredBets = useMemo(() => {
    return bets.filter(bet => {
      const procedureMatch = selectedProcedures.includes('todos') || selectedProcedures.includes(bet.procedure_type || 'aposta');
      const bookmakerMatch = selectedBookmakers.includes('todas') || selectedBookmakers.includes(bet.bookmaker_id);

      let walletMatch = true;
      if (selectedWallet !== 'todas') {
        const mainWallet = wallets.find(w => w.is_main_account && !w.profile_id);

        if (selectedWallet === mainWallet?.id) {
          walletMatch = bet.wallet_id === selectedWallet || (bet.profile_id && walletLinks[bet.wallet_id] === selectedWallet);
        } else {
          const isProfile = profiles.some(p => p.id === selectedWallet);
          if (isProfile) {
            walletMatch = bet.profile_id === selectedWallet;
          } else {
            walletMatch = bet.wallet_id === selectedWallet && !bet.profile_id;
          }
        }
      }

      return procedureMatch && bookmakerMatch && walletMatch;
    });
  }, [bets, selectedProcedures, selectedBookmakers, selectedWallet, wallets, walletLinks, profiles]);

  // âœ… Calcular stats dos bets filtrados
  const stats = useMemo(() => {
    const totalProfit = filteredBets.reduce((sum, bet) => sum + (bet.profit_loss || 0), 0);
    const manualProfits = profitRecords.reduce((sum, record) => sum + (record.amount || 0), 0);

    const processedGroups = new Set();
    const groupKey = (bet) => `${bet.event_name}_${bet.market}_${bet.selection}_${bet.odds}_${bet.event_date}_${bet.bookmaker_id}`;

    let totalInvestment = 0;
    let greenOps = 0;
    let redOps = 0;

    filteredBets.forEach(bet => {
      const key = groupKey(bet);
      if (!processedGroups.has(key)) {
        const isFreebetExtraction = bet.procedure_type === 'extracao_freebet';
        const mainStake = isFreebetExtraction ? 0 : (bet.stake || 0);
        const protectionStake = (bet.protection_bookmakers || []).reduce((sum, p) => sum + (parseFloat(p.stake) || 0), 0);
        const additionalStake = (bet.additional_bets || []).reduce((sum, a) => sum + (parseFloat(a.stake) || 0), 0);
        totalInvestment += mainStake + protectionStake + additionalStake + (bet.procedure_loss || 0);

        if (['green', 'bateu_protecao', 'duplo_green', 'triplo_green', 'meio_duplo'].includes(bet.status)) {
          greenOps++;
        } else if (bet.status === 'red') {
          redOps++;
        }
        processedGroups.add(key);
      }
    });

    const totalPagamentos = payments
      .filter(p => p.status === 'paid')
      .reduce((sum, p) => sum + (p.amount || 0), 0);

    const lucroBruto = totalProfit + manualProfits;
    const lucroLiquido = lucroBruto - totalPagamentos;
    const roi = totalInvestment > 0 ? (lucroLiquido / totalInvestment) * 100 : 0;

    return {
      lucroBruto,
      lucroLiquido,
      totalPagamentos,
      totalInvestment,
      roi,
      greenOperations: greenOps,
      redOperations: redOps
    };
  }, [filteredBets, profitRecords, payments]);

  // âœ… Agrupamento por procedimento
  const procedureGroups = useMemo(() => {
    const groups = {};
    const processedGroups = new Set();
    const groupKey = (bet) => `${bet.event_name}_${bet.market}_${bet.selection}_${bet.odds}_${bet.event_date}_${bet.bookmaker_id}`;

    filteredBets.forEach(bet => {
      const key = groupKey(bet);
      const procedure = bet.procedure_type || 'aposta';

      if (!groups[procedure]) {
        groups[procedure] = {
          totalProfit: 0,
          totalStake: 0,
          count: 0,
          greenCount: 0
        };
      }

      groups[procedure].totalProfit += bet.profit_loss || 0;

      if (!processedGroups.has(key)) {
        const isFreebetExtraction = bet.procedure_type === 'extracao_freebet';
        const mainStake = isFreebetExtraction ? 0 : (bet.stake || 0);
        const protectionStake = (bet.protection_bookmakers || []).reduce((sum, p) => sum + (parseFloat(p.stake) || 0), 0);
        const additionalStake = (bet.additional_bets || []).reduce((sum, a) => sum + (parseFloat(a.stake) || 0), 0);
        groups[procedure].totalStake += mainStake + protectionStake + additionalStake + (bet.procedure_loss || 0);
        groups[procedure].count++;

        if (['green', 'bateu_protecao', 'duplo_green', 'triplo_green', 'meio_duplo'].includes(bet.status)) {
          groups[procedure].greenCount++;
        }

        processedGroups.add(key);
      }
    });

    profitRecords.forEach(record => {
      const category = record.category || 'outro';
      if (!groups[category]) {
        groups[category] = {
          totalProfit: 0,
          totalStake: 0,
          count: 0,
          greenCount: 0
        };
      }
      groups[category].totalProfit += record.amount || 0;
      groups[category].count++;
    });

    return Object.entries(groups).map(([name, data]) => ({
      name,
      ...data,
      roi: data.totalStake > 0 ? (data.totalProfit / data.totalStake) * 100 : 0,
      winRate: data.count > 0 ? (data.greenCount / data.count) * 100 : 0
    })).sort((a, b) => b.totalProfit - a.totalProfit);
  }, [filteredBets, profitRecords]);

  // Handlers
  const handleSaveLinks = async () => {
    try {
      for (const [walletId, mainWalletId] of Object.entries(walletLinks)) {
        const wallet = wallets.find(w => w.id === walletId);
        if (wallet && wallet.linked_main_wallet_id !== mainWalletId) {
          await Wallet.update(walletId, {
            linked_main_wallet_id: mainWalletId || null
          });
        }
      }
      setShowLinkDialog(false);
      toast.success('âœ… VÃ­nculos salvos!');
      await loadData();
    } catch (error) {
      console.error('Erro:', error);
      toast.error('âŒ Erro ao salvar vÃ­nculos');
    }
  };

  const toggleWalletLink = (thirdPartyWalletId, mainWalletId) => {
    setWalletLinks(prev => ({
      ...prev,
      [thirdPartyWalletId]: prev[thirdPartyWalletId] === mainWalletId ? null : mainWalletId
    }));
  };

  const toggleProcedure = (procedure) => {
    setSelectedProcedures(prev => {
      if (procedure === 'todos') return ['todos'];
      const newSelection = prev.filter(p => p !== 'todos');
      if (newSelection.includes(procedure)) {
        const filtered = newSelection.filter(p => p !== procedure);
        return filtered.length === 0 ? ['todos'] : filtered;
      }
      return [...newSelection, procedure];
    });
  };

  const toggleBookmaker = (bookmakerId) => {
    setSelectedBookmakers(prev => {
      if (bookmakerId === 'todas') return ['todas'];
      const newSelection = prev.filter(b => b !== 'todas');
      if (newSelection.includes(bookmakerId)) {
        const filtered = newSelection.filter(b => b !== bookmakerId);
        return filtered.length === 0 ? ['todas'] : filtered;
      }
      return [...newSelection, bookmakerId];
    });
  };

  const handleAddRecord = async () => {
    try {
      if (!newRecord.title || !newRecord.amount || !newRecord.record_date) {
        toast.error('âŒ Preencha os campos obrigatÃ³rios');
        return;
      }

      await ProfitRecord.create({
        ...newRecord,
        amount: parseFloat(newRecord.amount),
        created_by: currentUser.email
      });

      toast.success('âœ… Registro adicionado!');
      setShowAddRecordDialog(false);
      setNewRecord({
        title: '',
        amount: '',
        record_date: new Date().toISOString().split('T')[0],
        period_type: 'daily',
        category: 'aposta',
        bookmaker_id: '',
        wallet_id: '',
        notes: ''
      });
      await loadData();
    } catch (error) {
      console.error('Erro:', error);
      toast.error('âŒ Erro ao adicionar registro');
    }
  };

  const handleDeleteRecord = async (recordId) => {
    try {
      await ProfitRecord.delete(recordId);
      toast.success('âœ… Registro excluÃ­do!');
      await loadData();
    } catch (error) {
      console.error('Erro:', error);
      toast.error('âŒ Erro ao excluir registro');
    }
  };

  // âœ… NOVO: Exportar dados
  const handleExportData = () => {
    const data = {
      resumo: {
        lucroBruto: stats.lucroBruto,
        lucroLiquido: stats.lucroLiquido,
        totalPagamentos: stats.totalPagamentos,
        totalInvestimento: stats.totalInvestment,
        roi: stats.roi,
        winRate: calculateProfits.winRate
      },
      procedimentos: procedureGroups,
      filtros: {
        procedimentos: selectedProcedures,
        casas: selectedBookmakers,
        conta: selectedWallet
      }
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `lucros-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    toast.success('âœ… Dados exportados!');
  };

  const getAllWalletsForFilter = () => {
    const accounts = [];
    const mainWallet = wallets.find(w => w.is_main_account && !w.profile_id);
    if (mainWallet) {
      accounts.push({ id: mainWallet.id, name: mainWallet.name, type: 'main' });
    }

    wallets.filter(w => !w.is_main_account && !w.profile_id).forEach(wallet => {
      accounts.push({ id: wallet.id, name: wallet.name, type: 'sub' });
    });

    profiles.forEach(profile => {
      accounts.push({ id: profile.id, name: profile.name, type: 'third_party' });
    });

    return accounts;
  };

  const allAccountsForFilter = getAllWalletsForFilter();

  const procedureLabels = {
    'aposta': 'ðŸŽ¯ Aposta Normal',
    'superodd': 'âš¡ Super Odd',
    'giros_gratis': 'ðŸŽ° Giros GrÃ¡tis',
    'procedimento_freebet': 'ðŸ“‹ Procedimento de Freebet',
    'extracao_freebet': 'ðŸ’Ž ExtraÃ§Ã£o de Freebet',
    'cashback': 'ðŸ’° Cashback',
    'multipla': 'ðŸŽ² MÃºltipla',
    'meio_duplo': 'ðŸŒ— Meio Duplo',
    'duplo_green': 'ðŸ¾ Duplo Green',
    'triplo_green': 'ðŸ™ Triplo Green',
    'bonus': 'ðŸŽ BÃ´nus',
    'outro': 'ðŸ’¡ Outro'
  };

  const availableProcedures = Object.keys(procedureLabels);

  // âœ… Filtrar bookmakers e procedures pela busca
  const filteredBookmakersForFilter = useMemo(() => {
    if (!searchBookmaker) return bookmakers;
    return bookmakers.filter(b => 
      b.name.toLowerCase().includes(searchBookmaker.toLowerCase())
    );
  }, [bookmakers, searchBookmaker]);

  const filteredProceduresForFilter = useMemo(() => {
    if (!searchProcedure) return availableProcedures;
    return availableProcedures.filter(proc => 
      procedureLabels[proc].toLowerCase().includes(searchProcedure.toLowerCase())
    );
  }, [searchProcedure]);

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-4 md:p-8">
      {profitsTutorial && (
        <InteractiveTutorial
          pageId="profits"
          title={profitsTutorial.title}
          steps={profitsTutorial.steps}
        />
      )}

      <div className="w-full max-w-7xl mx-auto">
        {/* HEADER */}
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
          <div>
            <h1 className="text-3xl md:text-4xl font-bold text-white mb-2">ðŸ’° AnÃ¡lise de Lucros</h1>
            <p className="text-slate-400">VisÃ£o detalhada dos seus lucros por procedimento e conta</p>
          </div>
          <div className="flex gap-2">
            <Button
              onClick={handleExportData}
              variant="outline"
              className="bg-slate-800 border-slate-700 text-white hover:bg-slate-700"
            >
              <Download className="w-4 h-4 mr-2" />
              Exportar
            </Button>
            <Button
              onClick={() => setShowAddRecordDialog(true)}
              className="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700"
            >
              <Plus className="w-4 h-4 mr-2" />
              Adicionar Lucro
            </Button>
            <Button
              onClick={() => setShowLinkDialog(true)}
              className="bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600"
            >
              <LinkIcon className="w-4 h-4 mr-2" />
              VÃ­nculos
            </Button>
          </div>
        </div>

        {/* FILTROS APRIMORADOS */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-8">
          {/* Filtro de Procedimentos */}
          <Card className="bg-slate-800 border-slate-700">
            <CardHeader 
              className="cursor-pointer hover:bg-slate-700/30 transition-colors"
              onClick={() => setShowProceduresFilter(!showProceduresFilter)}
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <Filter className="w-4 h-4 text-blue-400" />
                  <span className="text-white font-semibold">Procedimentos</span>
                  {selectedProcedures.filter(p => p !== 'todos').length > 0 && (
                    <Badge className="bg-blue-600">
                      {selectedProcedures.filter(p => p !== 'todos').length}
                    </Badge>
                  )}
                </div>
                <ChevronDown className={`w-4 h-4 text-slate-400 transition-transform ${showProceduresFilter ? 'rotate-180' : ''}`} />
              </div>
            </CardHeader>
            <AnimatePresence>
              {showProceduresFilter && (
                <motion.div
                  initial={{ height: 0, opacity: 0 }}
                  animate={{ height: 'auto', opacity: 1 }}
                  exit={{ height: 0, opacity: 0 }}
                  className="overflow-hidden"
                >
                  <CardContent className="pt-0">
                    <div className="mb-3">
                      <div className="relative">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                        <Input
                          placeholder="Buscar procedimento..."
                          value={searchProcedure}
                          onChange={(e) => setSearchProcedure(e.target.value)}
                          className="pl-10 bg-slate-900 border-slate-700 text-white"
                        />
                      </div>
                    </div>
                    <div className="flex flex-wrap gap-2 max-h-60 overflow-y-auto">
                      <Button
                        variant={selectedProcedures.includes('todos') ? 'default' : 'outline'}
                        size="sm"
                        onClick={() => toggleProcedure('todos')}
                        className={selectedProcedures.includes('todos')
                          ? 'bg-blue-600 hover:bg-blue-700'
                          : 'bg-slate-900 border-slate-700 text-slate-300'
                        }
                      >
                        Todos
                      </Button>
                      {filteredProceduresForFilter.map(proc => (
                        <Button
                          key={proc}
                          variant={selectedProcedures.includes(proc) ? 'default' : 'outline'}
                          size="sm"
                          onClick={() => toggleProcedure(proc)}
                          className={selectedProcedures.includes(proc)
                            ? 'bg-blue-600 hover:bg-blue-700'
                            : 'bg-slate-900 border-slate-700 text-slate-300'
                          }
                        >
                          {procedureLabels[proc]}
                        </Button>
                      ))}
                    </div>
                  </CardContent>
                </motion.div>
              )}
            </AnimatePresence>
          </Card>

          {/* Filtro de Casas */}
          <Card className="bg-slate-800 border-slate-700">
            <CardHeader 
              className="cursor-pointer hover:bg-slate-700/30 transition-colors"
              onClick={() => setShowBookmakersFilter(!showBookmakersFilter)}
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <Building2 className="w-4 h-4 text-purple-400" />
                  <span className="text-white font-semibold">Casas</span>
                  {selectedBookmakers.filter(b => b !== 'todas').length > 0 && (
                    <Badge className="bg-purple-600">
                      {selectedBookmakers.filter(b => b !== 'todas').length}
                    </Badge>
                  )}
                </div>
                <ChevronDown className={`w-4 h-4 text-slate-400 transition-transform ${showBookmakersFilter ? 'rotate-180' : ''}`} />
              </div>
            </CardHeader>
            <AnimatePresence>
              {showBookmakersFilter && (
                <motion.div
                  initial={{ height: 0, opacity: 0 }}
                  animate={{ height: 'auto', opacity: 1 }}
                  exit={{ height: 0, opacity: 0 }}
                  className="overflow-hidden"
                >
                  <CardContent className="pt-0">
                    <div className="mb-3">
                      <div className="relative">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                        <Input
                          placeholder="Buscar casa..."
                          value={searchBookmaker}
                          onChange={(e) => setSearchBookmaker(e.target.value)}
                          className="pl-10 bg-slate-900 border-slate-700 text-white"
                        />
                      </div>
                    </div>
                    <div className="flex flex-wrap gap-2 max-h-60 overflow-y-auto">
                      <Button
                        variant={selectedBookmakers.includes('todas') ? 'default' : 'outline'}
                        size="sm"
                        onClick={() => toggleBookmaker('todas')}
                        className={selectedBookmakers.includes('todas')
                          ? 'bg-purple-600 hover:bg-purple-700'
                          : 'bg-slate-900 border-slate-700 text-slate-300'
                        }
                      >
                        Todas
                      </Button>
                      {filteredBookmakersForFilter.map(bookmaker => (
                        <Button
                          key={bookmaker.id}
                          variant={selectedBookmakers.includes(bookmaker.id) ? 'default' : 'outline'}
                          size="sm"
                          onClick={() => toggleBookmaker(bookmaker.id)}
                          className={selectedBookmakers.includes(bookmaker.id)
                            ? 'bg-purple-600 hover:bg-purple-700'
                            : 'bg-slate-900 border-slate-700 text-slate-300'
                          }
                        >
                          {bookmaker.name}
                        </Button>
                      ))}
                    </div>
                  </CardContent>
                </motion.div>
              )}
            </AnimatePresence>
          </Card>

          {/* Filtro de Contas */}
          <Card className="bg-slate-800 border-slate-700">
            <CardHeader>
              <div className="flex items-center gap-2">
                <WalletIcon className="w-4 h-4 text-green-400" />
                <span className="text-white font-semibold">Conta</span>
              </div>
            </CardHeader>
            <CardContent>
              <Select value={selectedWallet} onValueChange={setSelectedWallet}>
                <SelectTrigger className="bg-slate-900 border-slate-700 text-white">
                  <SelectValue placeholder="Todas as contas" />
                </SelectTrigger>
                <SelectContent className="bg-slate-800 border-slate-700 max-h-80 overflow-y-auto">
                  <SelectItem value="todas" className="text-white hover:bg-slate-700 font-semibold">
                    Todas as Contas
                  </SelectItem>

                  {allAccountsForFilter.filter(acc => acc.type === 'main').map(account => (
                    <SelectItem key={account.id} value={account.id} className="text-white hover:bg-slate-700">
                      <div className="flex items-center gap-2">
                        <WalletIcon className="w-4 h-4 text-blue-500" />
                        <span className="font-semibold">{account.name}</span>
                        <Badge variant="outline" className="text-xs">Principal</Badge>
                      </div>
                    </SelectItem>
                  ))}

                  {allAccountsForFilter.filter(acc => acc.type === 'third_party').length > 0 && (
                    <>
                      <SelectItem value="__separator__" disabled className="text-slate-400 text-xs">
                        â€” Terceiros â€”
                      </SelectItem>
                      {allAccountsForFilter.filter(acc => acc.type === 'third_party').map(account => (
                        <SelectItem key={account.id} value={account.id} className="text-white hover:bg-slate-700 pl-6">
                          <div className="flex items-center gap-2">
                            <Users className="w-4 h-4 text-purple-500" />
                            {account.name}
                          </div>
                        </SelectItem>
                      ))}
                    </>
                  )}
                </SelectContent>
              </Select>
            </CardContent>
          </Card>
        </div>

        {/* STATS CARDS APRIMORADOS */}
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
          <StatCard
            title="Lucro Bruto"
            value={formatCurrency(stats.lucroBruto)}
            subtitle="Antes de pagamentos"
            icon={TrendingUp}
            gradient="bg-gradient-to-br from-green-600 to-green-700"
            isLoading={isLoading}
          />

          <StatCard
            title="Pagamentos"
            value={formatCurrency(stats.totalPagamentos)}
            subtitle="Total pago"
            icon={Users}
            gradient="bg-gradient-to-br from-orange-600 to-orange-700"
            isLoading={isLoading}
          />

          <StatCard
            title="Lucro LÃ­quido"
            value={formatCurrency(stats.lucroLiquido)}
            subtitle="Lucro final"
            icon={DollarSign}
            gradient="bg-gradient-to-br from-blue-600 to-blue-700"
            isLoading={isLoading}
          />

          <StatCard
            title="ROI"
            value={`${stats.roi.toFixed(1)}%`}
            subtitle="Retorno sobre investimento"
            icon={Activity}
            gradient="bg-gradient-to-br from-purple-600 to-purple-700"
            trend={stats.roi > 0 ? '+' + stats.roi.toFixed(1) + '%' : stats.roi.toFixed(1) + '%'}
            isLoading={isLoading}
          />

          <StatCard
            title="Win Rate"
            value={`${calculateProfits.winRate.toFixed(1)}%`}
            subtitle={`${calculateProfits.greenOperations}/${calculateProfits.greenOperations + calculateProfits.redOperations}`}
            icon={Target}
            gradient="bg-gradient-to-br from-pink-600 to-pink-700"
            isLoading={isLoading}
          />
        </div>

        {/* REGISTROS MANUAIS */}
        {profitRecords.length > 0 && (
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="mb-8"
          >
            <Card className="bg-slate-800 border-slate-700">
              <CardHeader>
                <CardTitle className="text-white flex items-center gap-2">
                  ðŸ“Š Registros Manuais de Lucro
                  <Badge variant="outline" className="border-green-600 text-green-400">
                    {profitRecords.length}
                  </Badge>
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {profitRecords.map((record) => (
                    <motion.div
                      key={record.id}
                      whileHover={{ scale: 1.02 }}
                      className="bg-gradient-to-br from-slate-700 to-slate-700/50 rounded-lg p-4 border border-slate-600"
                    >
                      <div className="flex justify-between items-start mb-2">
                        <h4 className="font-bold text-white">{record.title}</h4>
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => handleDeleteRecord(record.id)}
                          className="text-red-400 hover:text-red-300 hover:bg-red-900/20"
                        >
                          <X className="w-4 h-4" />
                        </Button>
                      </div>
                      <p className={`text-2xl font-bold ${record.amount >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                        {record.amount >= 0 ? '+' : ''}{formatCurrency(record.amount)}
                      </p>
                      <div className="flex items-center gap-2 mt-2 text-xs text-slate-400">
                        <Calendar className="w-3 h-3" />
                        {new Date(record.record_date).toLocaleDateString('pt-BR')}
                      </div>
                      {record.notes && (
                        <p className="text-xs text-slate-400 mt-2 line-clamp-2">{record.notes}</p>
                      )}
                    </motion.div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {/* LUCRO POR PROCEDIMENTO */}
        <Card className="bg-slate-800 border-slate-700">
          <CardHeader>
            <CardTitle className="text-white">ðŸ’Ž Lucro por Procedimento</CardTitle>
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <div className="space-y-4">
                {[...Array(5)].map((_, i) => (
                  <Skeleton key={i} className="h-32 rounded-xl bg-slate-700" />
                ))}
              </div>
            ) : procedureGroups.length === 0 ? (
              <div className="text-center py-16">
                <AlertCircle className="w-16 h-16 mx-auto mb-4 text-slate-600" />
                <p className="text-slate-400">Nenhum dado de lucro disponÃ­vel</p>
              </div>
            ) : (
              <div className="space-y-4">
                {procedureGroups.map((group, index) => (
                  <ProcedureCard 
                    key={index}
                    group={group}
                    procedureLabel={procedureLabels[group.name] || group.name}
                  />
                ))}
              </div>
            )}
          </CardContent>
        </Card>

        {/* DIALOGS */}
        <Dialog open={showAddRecordDialog} onOpenChange={setShowAddRecordDialog}>
          <DialogContent className="max-w-2xl bg-slate-800 border-slate-700">
            <DialogHeader>
              <DialogTitle className="text-white">Adicionar Registro de Lucro</DialogTitle>
              <DialogDescription className="text-slate-400">
                Adicione lucros ou prejuÃ­zos manuais
              </DialogDescription>
            </DialogHeader>

            <div className="space-y-4 mt-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <Label htmlFor="title" className="text-slate-300">TÃ­tulo *</Label>
                  <Input
                    id="title"
                    value={newRecord.title}
                    onChange={(e) => setNewRecord({...newRecord, title: e.target.value})}
                    placeholder="Ex: Lucro do dia 15/01"
                    className="bg-slate-900 border-slate-700 text-white"
                  />
                </div>

                <div>
                  <Label htmlFor="amount" className="text-slate-300">Valor (R$) *</Label>
                  <Input
                    id="amount"
                    type="number"
                    step="0.01"
                    value={newRecord.amount}
                    onChange={(e) => setNewRecord({...newRecord, amount: e.target.value})}
                    placeholder="0.00"
                    className="bg-slate-900 border-slate-700 text-white"
                  />
                </div>

                <div>
                  <Label htmlFor="date" className="text-slate-300">Data *</Label>
                  <Input
                    id="date"
                    type="date"
                    value={newRecord.record_date}
                    onChange={(e) => setNewRecord({...newRecord, record_date: e.target.value})}
                    className="bg-slate-900 border-slate-700 text-white"
                  />
                </div>

                <div>
                  <Label htmlFor="period" className="text-slate-300">PerÃ­odo</Label>
                  <Select value={newRecord.period_type} onValueChange={(value) => setNewRecord({...newRecord, period_type: value})}>
                    <SelectTrigger className="bg-slate-900 border-slate-700 text-white">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent className="bg-slate-800 border-slate-700">
                      <SelectItem value="daily" className="text-white">DiÃ¡rio</SelectItem>
                      <SelectItem value="weekly" className="text-white">Semanal</SelectItem>
                      <SelectItem value="monthly" className="text-white">Mensal</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div>
                <Label htmlFor="notes" className="text-slate-300">ObservaÃ§Ãµes</Label>
                <Textarea
                  id="notes"
                  value={newRecord.notes}
                  onChange={(e) => setNewRecord({...newRecord, notes: e.target.value})}
                  placeholder="Adicione observaÃ§Ãµes..."
                  className="bg-slate-900 border-slate-700 text-white"
                  rows={3}
                />
              </div>
            </div>

            <DialogFooter>
              <Button
                variant="outline"
                onClick={() => setShowAddRecordDialog(false)}
                className="bg-slate-700 border-slate-600 text-slate-300"
              >
                Cancelar
              </Button>
              <Button
                onClick={handleAddRecord}
                className="bg-gradient-to-r from-green-600 to-emerald-600"
              >
                <Plus className="w-4 h-4 mr-2" />
                Adicionar
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>

        <Dialog open={showLinkDialog} onOpenChange={setShowLinkDialog}>
          <DialogContent className="max-w-4xl max-h-[80vh] overflow-y-auto bg-slate-800 border-slate-700">
            <DialogHeader>
              <DialogTitle className="text-white flex items-center gap-2">
                <LinkIcon className="w-6 h-6 text-blue-500" />
                Vincular Contas de Terceiros
              </DialogTitle>
              <DialogDescription className="text-slate-400">
                Vincule contas para agrupar anÃ¡lises de lucro
              </DialogDescription>
            </DialogHeader>

            <div className="mt-6 space-y-6">
              {profiles.length === 0 ? (
                <div className="bg-amber-900/20 border border-amber-700 p-4 rounded-lg text-center">
                  <AlertCircle className="w-8 h-8 mx-auto mb-2 text-amber-400" />
                  <p className="text-sm text-amber-200">
                    Nenhuma conta de terceiro encontrada
                  </p>
                </div>
              ) : (
                <div className="space-y-6">
                  {profiles.map(profile => {
                    const profileWallets = wallets.filter(w => w.profile_id === profile.id);
                    if (profileWallets.length === 0) return null;

                    return (
                      <div key={profile.id} className="border border-slate-600 rounded-lg p-4">
                        <div className="flex items-center gap-3 mb-4">
                          <div
                            className="w-4 h-4 rounded-full"
                            style={{ backgroundColor: profile.color || '#8B5CF6' }}
                          />
                          <h3 className="text-lg font-bold text-white">{profile.name}</h3>
                          <Badge variant="outline" className="border-slate-500 text-slate-300">
                            {profileWallets.length} {profileWallets.length === 1 ? 'conta' : 'contas'}
                          </Badge>
                        </div>

                        <div className="space-y-3">
                          {profileWallets.map(wallet => (
                            <div key={wallet.id} className="bg-slate-700 p-4 rounded-lg">
                              <div className="flex items-center justify-between mb-3">
                                <div className="flex items-center gap-2">
                                  <WalletIcon className="w-4 h-4 text-slate-400" />
                                  <span className="font-semibold text-white">{wallet.name}</span>
                                </div>
                                {walletLinks[wallet.id] && (
                                  <Badge className="bg-green-600">âœ“ Vinculada</Badge>
                                )}
                              </div>

                              <div className="space-y-2">
                                {wallets.filter(w => w.is_main_account && !w.profile_id).map(mainWallet => (
                                  <div
                                    key={mainWallet.id}
                                    onClick={() => toggleWalletLink(wallet.id, mainWallet.id)}
                                    className={`flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all ${
                                      walletLinks[wallet.id] === mainWallet.id
                                        ? 'border-blue-500 bg-blue-950'
                                        : 'border-slate-600 hover:border-blue-700'
                                    }`}
                                  >
                                    <Checkbox checked={walletLinks[wallet.id] === mainWallet.id} />
                                    <div>
                                      <p className="font-medium text-white">{mainWallet.name}</p>
                                      <Badge variant="outline" className="text-xs mt-1">Principal</Badge>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            <DialogFooter className="pt-6 border-t border-slate-600">
              <Button
                variant="outline"
                onClick={() => setShowLinkDialog(false)}
                className="bg-slate-700 border-slate-600 text-slate-300"
              >
                Cancelar
              </Button>
              <Button
                onClick={handleSaveLinks}
                className="bg-gradient-to-r from-blue-600 to-blue-500"
              >
                <LinkIcon className="w-4 h-4 mr-2" />
                Salvar VÃ­nculos
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </div>
  );
}
